<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AirTickets - Confirmaci√≥n</title>
  <link rel="stylesheet" href="assets/styles.css" />
  <!-- Incluir la librer√≠a jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    html,body{height:auto}
    .confirmation-badge {
      background: #d4edda;
      color: #155724;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 15px;
      border: 1px solid #c3e6cb;
    }
    .resumen-section {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
    }
    .total-pago {
      background: #e8f5e8;
      color: #2d5016;
      padding: 12px;
      border-radius: 4px;
      margin-top: 10px;
      font-weight: bold;
    }
    .flight-details {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
    }
    .flight-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .flight-airline-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .airline-logo {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      object-fit: contain;
    }
    .flight-airline {
      font-weight: 600;
      font-size: 18px;
      color: #1a56db;
    }
    .flight-price {
      font-weight: 800;
      font-size: 22px;
      color: #16a34a;
    }
    .flight-route {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .flight-times {
      display: flex;
      align-items: center;
      gap: 20px;
      width: 100%;
      justify-content: center;
    }
    .flight-time {
      text-align: center;
      flex: 1;
    }
    .time-main {
      font-weight: 700;
      font-size: 16px;
    }
    .time-city {
      font-size: 12px;
      color: #666;
    }
    .flight-duration {
      text-align: center;
      color: #666;
      font-size: 12px;
      min-width: 80px;
    }
    .flight-info {
      display: flex;
      gap: 16px;
      margin-top: 8px;
      font-size: 12px;
      color: #666;
      flex-wrap: wrap;
    }
    .flight-info-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .flight-type-badge {
      background: #e0f2fe;
      color: #0369a1;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-left: 8px;
    }
    .flight-combined {
      background: #f0f9ff;
      border-left: 3px solid #0ea5e9;
    }
    .flight-code-display {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    .pdf-download-section {
      background: #e3f2fd;
      border-radius: 8px;
      padding: 16px;
      margin: 20px 0;
      border: 1px solid #bbdefb;
      text-align: center;
    }
    .btn-pdf {
      background: #d32f2f;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: background 0.3s;
    }
    .btn-pdf:hover {
      background: #b71c1c;
    }
    .btn-pdf:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    .pdf-icon {
      font-size: 18px;
    }

    .reserva-guardada-badge {
      background: #e8f5e8;
      color: #2d5016;
      padding: 12px;
      border-radius: 4px;
      margin: 15px 0;
      border: 1px solid #c3e6cb;
      text-align: center;
    }

    /* Estilos espec√≠ficos para el PDF */
    .pdf-template {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: white;
    }
    .pdf-header {
      text-align: center;
      border-bottom: 2px solid #1a56db;
      padding-bottom: 15px;
      margin-bottom: 20px;
    }
    .pdf-logo {
      font-size: 24px;
      font-weight: bold;
      color: #1a56db;
      margin-bottom: 5px;
    }
    .pdf-title {
      font-size: 20px;
      color: #333;
      margin-bottom: 10px;
    }
    .pdf-section {
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 12px;
    }
    .pdf-section-title {
      font-weight: bold;
      color: #1a56db;
      margin-bottom: 8px;
      font-size: 16px;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }
    .pdf-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }
    .pdf-label {
      font-weight: bold;
      color: #555;
    }
    .pdf-value {
      color: #333;
    }
    .pdf-total {
      background: #e8f5e8;
      padding: 10px;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      margin-top: 15px;
    }
    .pdf-footer {
      text-align: center;
      margin-top: 20px;
      font-size: 12px;
      color: #666;
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }
  </style>
</head>
<body>
<div class="shell">
  <header class="header">
    <div class="brand">
      <div class="brand-badge">‚úà</div>
      <div>
        <div class="brand-title">AirTickets</div>
        <div class="brand-sub">Admin</div>
      </div>
    </div>
  </header>
  <aside class="sidebar">
    <nav class="nav">
      <a href="index.html" class=""><span class="icon">üè†</span><span>Inicio</span></a>
      <a href="buscar.html" class="active"><span class="icon">‚úàÔ∏è</span><span>Vuelos</span></a>
      <a href="reservas.html" class=""><span class="icon">üìñ</span><span>Reservaciones</span></a>
      <a href="aerolineas.html" class=""><span class="icon">üõ©Ô∏è</span><span>Aerol√≠neas</span></a>
      <a href="estadisticas.html" class=""><span class="icon">üìä</span><span>Estad√≠sticas</span></a>
      <a href="reclamos.html" class=""><span class="icon">üí¨</span><span>Reclamos</span></a>
    </nav>
  </aside>
  <main class="content">
    <div class="card">
      <div class="confirmation-badge">
        <strong>‚úî ¬°Reserva Confirmada!</strong> Su reserva ha sido procesada exitosamente.
      </div>

      <!-- Notificaci√≥n de reserva guardada -->
      <div class="reserva-guardada-badge" id="reservaGuardadaBadge" style="display: none;">
        <strong>üíæ Reserva Guardada</strong> - Tu reserva ha sido guardada autom√°ticamente. Puedes verla en cualquier momento en la secci√≥n "Reservaciones".
      </div>

      <div class="badge gray" style="margin-bottom:20px">
        C√≥digo de reserva: <span id="codigoReserva" style="font-weight:bold">Cargando...</span>
      </div>

      <!-- Secci√≥n de descarga PDF -->
      <div class="pdf-download-section">
        <h3 style="margin: 0 0 15px 0; color: #1a56db;">üìÑ Descargar Comprobante</h3>
        <p style="margin: 0 0 15px 0; color: #555;">
          Puede descargar su comprobante de reserva en formato PDF para sus registros.
        </p>
        <button id="btnDescargarPDF" class="btn-pdf">
          <span class="pdf-icon">üì•</span>
          Descargar PDF
        </button>
        <div id="pdfStatus" style="margin-top: 10px; font-size: 14px;"></div>
      </div>

      <!-- Informaci√≥n del Vuelo - Estilo similar a pago.html -->
      <div id="flightDetails" class="flight-details">
        <div class="flight-header">
          <div class="flight-airline-info">
            <img id="airlineLogo" class="airline-logo" src="" alt="Logo aerol√≠nea">
            <div>
              <div class="flight-airline" id="flightAirline">Cargando informaci√≥n del vuelo...</div>
              <div class="flight-code-display" id="flightCode">C√≥digo: -</div>
            </div>
          </div>
          <div class="flight-price" id="flightPrice">-</div>
        </div>
        <div class="flight-route">
          <div class="flight-times">
            <div class="flight-time">
              <div class="time-main" id="departureTime">--:--</div>
              <div class="time-city" id="originCity">Origen</div>
            </div>
            <div class="flight-duration">
              <div>‚è±</div>
              <div id="flightDuration">-</div>
            </div>
            <div class="flight-time">
              <div class="time-main" id="arrivalTime">--:--</div>
              <div class="time-city" id="destinationCity">Destino</div>
            </div>
          </div>
        </div>
        <div class="flight-info">
          <div class="flight-info-item">
            <span>üõ©Ô∏è</span>
            <span id="flightAircraft">Avi√≥n: -</span>
          </div>
          <div class="flight-info-item">
            <span>üë•</span>
            <span id="flightPassengers">Pasajeros: -</span>
          </div>
          <div class="flight-info-item">
            <span>üìÖ</span>
            <span id="flightDate">Fecha: -</span>
          </div>
          <div id="flightTypeBadge" class="flight-info-item"></div>
        </div>
        <div id="additionalInfo" class="flight-info"></div>
      </div>

      <div class="grid-2" style="gap:20px; margin-bottom:20px">
        <!-- Informaci√≥n del Pasajero -->
        <div class="resumen-section">
          <div class="label" style="font-size:16px; margin-bottom:12px;">üë§ Datos del Pasajero</div>
          <div class="space-y">
            <div class="badge gray">Nombre: <b id="nombrePasajero">Cargando...</b></div>
            <div class="badge gray">Fecha de Nacimiento: <b id="fechaNacimiento">Cargando...</b></div>
            <div class="badge gray">Pasaporte: <b id="pasaporte">Cargando...</b></div>
            <div class="badge gray">Preferencia de Asiento: <b id="preferenciaAsiento">Cargando...</b></div>
            <div class="badge gray">M√©todo de Pago: <b id="metodoPago">Cargando...</b></div>
          </div>
        </div>

        <!-- Informaci√≥n Adicional -->
        <div class="resumen-section">
          <div class="label" style="font-size:16px; margin-bottom:12px;">üìã Detalles Adicionales</div>
          <div class="space-y">
            <div class="badge gray">Estado: <b style="color:green">Confirmado</b></div>
            <div class="badge gray">Check-in: <b>Disponible 24h antes</b></div>
            <div class="badge gray">Equipaje: <b>1 pieza 23kg + equipaje de mano</b></div>
            <div class="badge gray">Clase: <b>Econ√≥mica</b></div>
          </div>
        </div>
      </div>

      <!-- Total Pagado -->
      <div class="total-pago">
        üí∞ Total Pagado: <b id="totalPagado">Cargando...</b>
      </div>

      <div class="space-y" style="margin-top:20px">
        <div class="label">üìù Pr√≥ximos Pasos</div>
        <ul class="muted" style="line-height:1.6">
          <li>‚è∞ Llegue al aeropuerto 2 horas antes del vuelo internacional</li>
          <li>üìÑ Tenga pasaporte y c√≥digo de reserva listos</li>
          <li>üñ•Ô∏è Puede hacer check-in online 24 horas antes del vuelo</li>
          <li>üìû Para asistencia, contacte a nuestro servicio al cliente</li>
          <li>üíæ <strong>Su reserva ha sido guardada autom√°ticamente</strong> y puede verla en "Reservaciones"</li>
        </ul>
      </div>

      <div class="row" style="margin-top:20px">
        <a class="btn secondary" href="reservas.html">Ver mis reservas</a>
        <a class="btn right" href="buscar.html">Realizar nueva b√∫squeda</a>
      </div>
    </div>
  </main>
</div>

<script>
  // Datos de aeropuertos
  const aeropuertos = [
    { code: 'BOG', city: 'Bogot√°', country: 'Colombia' },
    { code: 'MDE', city: 'Medell√≠n', country: 'Colombia' },
    { code: 'CLO', city: 'Cali', country: 'Colombia' },
    { code: 'BAQ', city: 'Barranquilla', country: 'Colombia' },
    { code: 'SAL', city: 'San Salvador', country: 'El Salvador' },
    { code: 'MIA', city: 'Miami', country: 'USA' },
    { code: 'PTY', city: 'Panama City', country: 'Panama' },
    { code: 'LAS', city: 'Las Vegas', country: 'USA' },
    { code: 'MAD', city: 'Madrid', country: 'Espa√±a' },
    { code: 'LIM', city: 'Lima', country: 'Per√∫' },
    { code: 'MEX', city: 'Ciudad de M√©xico', country: 'M√©xico' },
    { code: 'CDG', city: 'Par√≠s', country: 'Francia' },
    { code: 'JFK', city: 'Nueva York', country: 'USA' },
    { code: 'CUN', city: 'Canc√∫n', country: 'M√©xico' },
    { code: 'GDL', city: 'Guadalajara', country: 'M√©xico' },
    { code: 'TIJ', city: 'Tijuana', country: 'M√©xico' },
    { code: 'MTY', city: 'Monterrey', country: 'M√©xico' }
  ];

  // Datos de aerol√≠neas con logos
  const aerolineas = [
    {
      id: 'delta',
      name: 'Delta Air',
      logo: 'https://s7d1.scene7.com/is/image/LippincottDM/Delta_03?fmt=webp&qlt=100'
    },
    {
      id: 'avianca',
      name: 'Avianca',
      logo: 'https://volavi.co/wp-content/uploads/2023/10/Nuevo-Logo_avianca-Octubre2023.jpg.webp'
    },
    {
      id: 'latam',
      name: 'LATAM',
      logo: 'https://photos.prnewswire.com/prnfull/20160428/361126LOGO'
    },
    {
      id: 'iberia',
      name: 'Iberia',
      logo: 'https://www.marcasrenombradas.com/wp-content/uploads/2011/08/Iberia.jpg'
    },
    {
      id: 'american',
      name: 'America Airlines',
      logo: 'https://assets.simpleviewinc.com/simpleview/image/upload/c_fill,h_1600,q_75,w_2400/v1/crm/tampabay/aArtboard-2_A737B76A-0BA5-49DB-F9DED6318A7C739C-a737b673bde148e_a737c1d3-f5a4-fa12-33635b09ca5fb2dd.jpg'
    },
    {
      id: 'qatar',
      name: 'Qatar Air',
      logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRD6OnNpaAsEqTYRCRYrG2qUB-ZPT9HzDiKBQ&s'
    },
    {
      id: 'emirates',
      name: 'Emirates Airways',
      logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSMWa43g3R335BROGk-pdEjAWqU6W1J9KaGlg&s'
    },
    {
      id: 'volaris',
      name: 'Volaris',
      logo: 'https://mir-s3-cdn-cf.behance.net/project_modules/fs_webp/6ce67d27128795.563602c83a3fc.jpg'
    }
  ];

  // Variables globales para almacenar datos
  let datosVuelo = null;
  let datosPasajero = null;
  let datosBusqueda = null;
  let codigoReserva = '';

  // Funci√≥n para guardar la reserva en localStorage
  function guardarReservaEnLocalStorage() {
    console.log('üíæ Guardando reserva en localStorage...');

    const reserva = {
      id: Date.now().toString(),
      codigo: codigoReserva,
      fechaReserva: new Date().toISOString(),
      estado: 'confirmado',
      metodoPago: sessionStorage.getItem('metodoPago') || 'No especificado',
      vuelo: datosVuelo,
      pasajeros: [datosPasajero],
      busqueda: datosBusqueda,
      precioTotal: datosVuelo.price ? datosVuelo.price * (datosBusqueda?.numPasajeros || 1) : 850000
    };

    // Obtener reservas existentes
    const reservasExistentes = JSON.parse(localStorage.getItem('reservasAirTickets') || '[]');

    // Verificar si la reserva ya existe
    const reservaExistente = reservasExistentes.find(r => r.codigo === codigoReserva);

    if (reservaExistente) {
      console.log('‚ö†Ô∏è La reserva ya existe en localStorage');
      return;
    }

    // Agregar nueva reserva al inicio
    reservasExistentes.unshift(reserva);

    // Guardar en localStorage
    localStorage.setItem('reservasAirTickets', JSON.stringify(reservasExistentes));

    console.log('‚úÖ Reserva guardada en localStorage:', reserva);

    // Mostrar notificaci√≥n de reserva guardada
    document.getElementById('reservaGuardadaBadge').style.display = 'block';

    return reserva;
  }

  // Funci√≥n para obtener el vuelo seleccionado
  function obtenerVueloSeleccionado() {
    console.log('üîç Buscando vuelo seleccionado...');

    // PRIMERO: Intentar obtener de sessionStorage
    const vueloGuardado = sessionStorage.getItem('vueloSeleccionado');
    if (vueloGuardado) {
      try {
        const vuelos = JSON.parse(vueloGuardado);
        console.log('üì¶ Vuelos encontrados en sessionStorage:', vuelos);

        // Si es un array, tomar el primer vuelo
        if (Array.isArray(vuelos) && vuelos.length > 0) {
          return vuelos[0];
        } else if (typeof vuelos === 'object') {
          // Si es un objeto directo, usarlo
          return vuelos;
        }
      } catch (error) {
        console.error('‚ùå Error al parsear vuelos:', error);
      }
    }

    // SEGUNDO: Intentar obtener de reservaCompleta
    const reservaCompleta = sessionStorage.getItem('reservaCompleta');
    if (reservaCompleta) {
      try {
        const reserva = JSON.parse(reservaCompleta);
        if (reserva.vuelo) {
          console.log('‚úÖ Vuelo encontrado en reservaCompleta:', reserva.vuelo);
          return reserva.vuelo;
        }
      } catch (error) {
        console.error('‚ùå Error al parsear reservaCompleta:', error);
      }
    }

    // TERCERO: Usar datos de prueba como fallback
    console.log('üîÑ Usando datos de prueba');
    return {
      id: 1,
      code: 'AV-101',
      airline: 'Avianca',
      airlineId: 'avianca',
      aircraft: 'Boeing 787-8 Dreamliner',
      origin: 'BOG',
      destination: 'MAD',
      departureTime: '14:30',
      arrivalTime: '06:45',
      duration: '9h 15m',
      price: 1850000,
      availableSeats: 45,
      flightType: 'directo'
    };
  }

  // Funci√≥n para actualizar informaci√≥n del vuelo
  function actualizarInformacionVuelo(vuelo, numPasajeros, datosBusqueda) {
    console.log('üîÑ Actualizando interfaz con vuelo:', vuelo);

    if (!vuelo) {
      console.error('‚ùå No hay datos de vuelo');
      document.getElementById('flightAirline').textContent = 'Error: No se pudo cargar la informaci√≥n del vuelo';
      return;
    }

    // Informaci√≥n de aeropuertos
    const origenInfo = aeropuertos.find(a => a.code === vuelo.origin);
    const destinoInfo = aeropuertos.find(a => a.code === vuelo.destination);

    // Informaci√≥n de aerol√≠nea
    let aerolineaInfo = null;
    if (vuelo.airlineId !== 'combinado') {
      aerolineaInfo = aerolineas.find(a => a.id === vuelo.airlineId);
    }

    // Actualizar logo
    const airlineLogo = document.getElementById('airlineLogo');
    if (aerolineaInfo && aerolineaInfo.logo) {
      airlineLogo.src = aerolineaInfo.logo;
      airlineLogo.alt = vuelo.airline;
    } else if (vuelo.airlineId === 'combinado') {
      airlineLogo.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iI2YwZjBmMCIvPgo8dGV4dCB4PSIxNiIgeT0iMTgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NiI+4pawK+KWsTwvdGV4dD4KPC9zdmc+';
      airlineLogo.alt = 'Vuelo combinado';
    }

    // Actualizar todos los elementos
    document.getElementById('flightAirline').textContent = vuelo.airline;
    document.getElementById('flightCode').textContent = `C√≥digo: ${vuelo.code}`;
    document.getElementById('flightPrice').textContent = `$${vuelo.price.toLocaleString()}`;
    document.getElementById('departureTime').textContent = vuelo.departureTime;
    document.getElementById('arrivalTime').textContent = vuelo.arrivalTime;
    document.getElementById('originCity').textContent = `${origenInfo ? origenInfo.city : vuelo.origin} (${vuelo.origin})`;
    document.getElementById('destinationCity').textContent = `${destinoInfo ? destinoInfo.city : vuelo.destination} (${vuelo.destination})`;
    document.getElementById('flightDuration').textContent = vuelo.duration;
    document.getElementById('flightAircraft').textContent = `Avi√≥n: ${vuelo.aircraft}`;
    document.getElementById('flightPassengers').textContent = `Pasajeros: ${numPasajeros || 1}`;

    // Fecha
    const fechaElement = document.getElementById('flightDate');
    if (datosBusqueda && datosBusqueda.fecha) {
      const fechaFormateada = new Date(datosBusqueda.fecha).toLocaleDateString('es-ES', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      fechaElement.textContent = `Fecha: ${fechaFormateada}`;
    } else {
      fechaElement.textContent = `Fecha: ${new Date().toLocaleDateString('es-ES', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      })}`;
    }

    // Tipo de vuelo
    const typeBadge = document.getElementById('flightTypeBadge');
    if (vuelo.escala || vuelo.flightType === 'combinado') {
      typeBadge.innerHTML = '<span class="flight-type-badge">üîÑ Vuelo con escala</span>';
      document.getElementById('flightDetails').classList.add('flight-combined');
    } else {
      typeBadge.innerHTML = '<span class="flight-type-badge">‚úàÔ∏è Vuelo directo</span>';
    }

    // Informaci√≥n adicional
    const additionalInfo = document.getElementById('additionalInfo');
    additionalInfo.innerHTML = '';

    if (vuelo.escala && vuelo.conexion) {
      const conexionInfo = aeropuertos.find(a => a.code === vuelo.conexion);
      if (conexionInfo) {
        const escalaItem = document.createElement('div');
        escalaItem.className = 'flight-info-item';
        escalaItem.innerHTML = `<span>‚è±</span><span>Escala en ${conexionInfo.city} (${vuelo.conexion})</span>`;
        additionalInfo.appendChild(escalaItem);
      }
    }

    // Asientos disponibles
    const seatsItem = document.createElement('div');
    seatsItem.className = 'flight-info-item';
    seatsItem.innerHTML = `<span>üí∫</span><span>${vuelo.availableSeats || 'Varios'} asientos disponibles</span>`;
    additionalInfo.appendChild(seatsItem);

    console.log('‚úÖ Interfaz de vuelo actualizada correctamente');
  }

  // Funci√≥n para obtener datos del pasajero
  function obtenerDatosPasajero() {
    const pasajerosGuardados = sessionStorage.getItem('datosPasajeros');
    let pasajero = {
      nombre: 'No especificado',
      fechaNacimiento: 'No especificada',
      pasaporte: 'No especificado',
      preferenciaAsiento: 'No especificada'
    };

    if (pasajerosGuardados) {
      try {
        const pasajeros = JSON.parse(pasajerosGuardados);
        if (pasajeros.length > 0) {
          pasajero = pasajeros[0]; // Tomar el primer pasajero
        }
      } catch (error) {
        console.error('Error al parsear pasajeros:', error);
      }
    }

    return pasajero;
  }

  // Funci√≥n para obtener m√©todo de pago
  function obtenerMetodoPago() {
    return sessionStorage.getItem('metodoPago') || 'No especificado';
  }

  // Funci√≥n para generar c√≥digo de reserva
  function generarCodigoReserva() {
    return 'R' + Math.random().toString(36).substring(2, 10).toUpperCase();
  }

  // Funci√≥n para formatear m√©todo de pago
  function formatearMetodoPago(metodo) {
    const metodos = {
      'tarjeta': 'Tarjeta de Cr√©dito/D√©bito',
      'transferencia': 'Transferencia Bancaria',
      'paypal': 'PayPal',
      'efectivo': 'Pago en Efectivo'
    };
    return metodos[metodo] || metodo;
  }

  // Funci√≥n para obtener datos de b√∫squeda
  function obtenerDatosBusqueda() {
    const busquedaGuardada = sessionStorage.getItem('busqueda');
    let busqueda = null;

    if (busquedaGuardada) {
      try {
        busqueda = JSON.parse(busquedaGuardada);
      } catch (error) {
        console.error('Error al parsear b√∫squeda:', error);
      }
    }

    return busqueda;
  }

  // Funci√≥n para generar y descargar PDF
  function generarPDF() {
    const btnDescargar = document.getElementById('btnDescargarPDF');
    const pdfStatus = document.getElementById('pdfStatus');

    // Deshabilitar bot√≥n durante la generaci√≥n
    btnDescargar.disabled = true;
    pdfStatus.textContent = 'üîÑ Generando PDF...';
    pdfStatus.style.color = '#1a56db';

    try {
      // Usar jsPDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Configuraci√≥n del documento
      doc.setFont('helvetica');
      doc.setFontSize(20);
      doc.setTextColor(26, 86, 219);
      doc.text('AirTickets - Comprobante de Reserva', 105, 20, { align: 'center' });

      // L√≠nea separadora
      doc.setDrawColor(26, 86, 219);
      doc.setLineWidth(1);
      doc.line(20, 25, 190, 25);

      // Informaci√≥n de la reserva
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text(`C√≥digo de Reserva: ${codigoReserva}`, 20, 35);
      doc.text(`Fecha de Emisi√≥n: ${new Date().toLocaleDateString('es-ES')}`, 20, 42);

      // Informaci√≥n del vuelo
      doc.setFontSize(14);
      doc.setTextColor(26, 86, 219);
      doc.text('INFORMACI√ìN DEL VUELO', 20, 55);

      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      let yPos = 65;

      // Datos del vuelo
      doc.text(`Aerol√≠nea: ${datosVuelo.airline}`, 20, yPos);
      doc.text(`N√∫mero de Vuelo: ${datosVuelo.code}`, 120, yPos);
      yPos += 7;

      doc.text(`Origen: ${datosVuelo.origin} - ${aeropuertos.find(a => a.code === datosVuelo.origin)?.city || datosVuelo.origin}`, 20, yPos);
      doc.text(`Destino: ${datosVuelo.destination} - ${aeropuertos.find(a => a.code === datosVuelo.destination)?.city || datosVuelo.destination}`, 120, yPos);
      yPos += 7;

      doc.text(`Salida: ${datosVuelo.departureTime}`, 20, yPos);
      doc.text(`Llegada: ${datosVuelo.arrivalTime}`, 120, yPos);
      yPos += 7;

      doc.text(`Duraci√≥n: ${datosVuelo.duration}`, 20, yPos);
      doc.text(`Aeronave: ${datosVuelo.aircraft}`, 120, yPos);
      yPos += 7;

      if (datosBusqueda && datosBusqueda.fecha) {
        doc.text(`Fecha: ${new Date(datosBusqueda.fecha).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`, 20, yPos);
      }
      yPos += 12;

      // Informaci√≥n del pasajero
      doc.setFontSize(14);
      doc.setTextColor(26, 86, 219);
      doc.text('INFORMACI√ìN DEL PASAJERO', 20, yPos);

      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      yPos += 10;

      doc.text(`Nombre: ${datosPasajero.nombre}`, 20, yPos);
      yPos += 7;

      doc.text(`Fecha de Nacimiento: ${datosPasajero.fechaNacimiento}`, 20, yPos);
      yPos += 7;

      doc.text(`Pasaporte: ${datosPasajero.pasaporte}`, 20, yPos);
      yPos += 7;

      doc.text(`Preferencia de Asiento: ${datosPasajero.preferenciaAsiento}`, 20, yPos);
      yPos += 7;

      doc.text(`M√©todo de Pago: ${formatearMetodoPago(obtenerMetodoPago())}`, 20, yPos);
      yPos += 12;

      // Informaci√≥n de pago
      doc.setFontSize(14);
      doc.setTextColor(26, 86, 219);
      doc.text('DETALLES DE PAGO', 20, yPos);

      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      yPos += 10;

      const numPasajeros = datosBusqueda ? datosBusqueda.numPasajeros : 1;
      const precioUnitario = datosVuelo.price || 850000;
      const total = precioUnitario * numPasajeros;

      doc.text(`Pasajeros: ${numPasajeros}`, 20, yPos);
      doc.text(`Precio unitario: $${precioUnitario.toLocaleString()}`, 120, yPos);
      yPos += 7;

      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.text(`TOTAL: $${total.toLocaleString()}`, 20, yPos);
      yPos += 15;

      // Informaci√≥n adicional
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.setTextColor(100, 100, 100);
      doc.text('Nota: Este documento es su comprobante de reserva. Pres√©ntelo en el aeropuerto junto con su documento de identidad.', 20, yPos, { maxWidth: 170 });
      yPos += 10;

      doc.text('Para check-in online, visite nuestro sitio web 24 horas antes de la salida de su vuelo.', 20, yPos, { maxWidth: 170 });
      yPos += 10;

      // Pie de p√°gina
      doc.setFontSize(8);
      doc.setTextColor(150, 150, 150);
      doc.text('AirTickets - Sistema de Reservas de Vuelos', 105, 280, { align: 'center' });
      doc.text('www.airtickets.com - servicio@airtickets.com', 105, 285, { align: 'center' });

      // Guardar el PDF
      const nombreArchivo = `Reserva_${codigoReserva}_${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(nombreArchivo);

      // Actualizar estado
      pdfStatus.textContent = '‚úÖ PDF descargado exitosamente';
      pdfStatus.style.color = 'green';

      console.log('‚úÖ PDF generado y descargado exitosamente');

    } catch (error) {
      console.error('‚ùå Error al generar PDF:', error);
      pdfStatus.textContent = '‚ùå Error al generar el PDF. Intente nuevamente.';
      pdfStatus.style.color = 'red';
    } finally {
      // Rehabilitar bot√≥n despu√©s de 2 segundos
      setTimeout(() => {
        btnDescargar.disabled = false;
      }, 2000);
    }
  }

  // Funci√≥n principal para cargar la confirmaci√≥n
  function cargarConfirmacion() {
    console.log('üîÑ Cargando datos de confirmaci√≥n...');

    // Obtener todos los datos
    datosVuelo = obtenerVueloSeleccionado();
    datosPasajero = obtenerDatosPasajero();
    const metodoPago = obtenerMetodoPago();
    datosBusqueda = obtenerDatosBusqueda();
    codigoReserva = sessionStorage.getItem('codigoReserva') || generarCodigoReserva();

    console.log('üìä Datos obtenidos:', { datosVuelo, datosBusqueda, datosPasajero, metodoPago });

    // Guardar c√≥digo de reserva en sessionStorage si no existe
    if (!sessionStorage.getItem('codigoReserva')) {
      sessionStorage.setItem('codigoReserva', codigoReserva);
    }

    // GUARDAR LA RESERVA AUTOM√ÅTICAMENTE AL CARGAR LA P√ÅGINA
    const reservaGuardada = guardarReservaEnLocalStorage();

    // Actualizar informaci√≥n del vuelo
    if (datosVuelo) {
      const numPasajeros = datosBusqueda ? datosBusqueda.numPasajeros : 1;
      actualizarInformacionVuelo(datosVuelo, numPasajeros, datosBusqueda);
    }

    // Actualizar informaci√≥n del pasajero
    document.getElementById('nombrePasajero').textContent = datosPasajero.nombre;
    document.getElementById('fechaNacimiento').textContent = datosPasajero.fechaNacimiento;
    document.getElementById('pasaporte').textContent = datosPasajero.pasaporte;
    document.getElementById('preferenciaAsiento').textContent = datosPasajero.preferenciaAsiento;
    document.getElementById('metodoPago').textContent = formatearMetodoPago(metodoPago);

    // Actualizar c√≥digo de reserva
    document.getElementById('codigoReserva').textContent = codigoReserva;

    // Actualizar total pagado
    if (datosVuelo && datosVuelo.price) {
      const numPasajeros = datosBusqueda ? datosBusqueda.numPasajeros : 1;
      const total = datosVuelo.price * numPasajeros;
      document.getElementById('totalPagado').textContent = `$${total.toLocaleString()}`;
    } else {
      document.getElementById('totalPagado').textContent = '$850.000';
    }

    // Configurar evento para el bot√≥n de descarga PDF
    document.getElementById('btnDescargarPDF').addEventListener('click', generarPDF);

    console.log('‚úÖ Confirmaci√≥n cargada exitosamente');
  }

  // Ejecutar cuando se cargue la p√°gina
  document.addEventListener('DOMContentLoaded', function() {
    cargarConfirmacion();

  });
</script>
</body>
</html>