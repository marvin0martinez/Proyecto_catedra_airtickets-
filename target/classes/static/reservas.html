<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AirTickets - Mis Reservas</title>
  <link rel="stylesheet" href="assets/styles.css" />
  <!-- Incluir la librer√≠a jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    html, body { height: auto; }

    .reserva-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #8e24aa;
      transition: transform 0.2s ease;
    }

    .reserva-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    .reserva-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .reserva-codigo {
      font-weight: bold;
      color: #8e24aa;
      font-size: 16px;
    }

    .reserva-estado {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }

    .estado-confirmado {
      background: #d4edda;
      color: #155724;
    }

    .estado-pendiente {
      background: #fff3cd;
      color: #856404;
    }

    .estado-cancelado {
      background: #f8d7da;
      color: #721c24;
    }

    .estado-checkin {
      background: #d1ecf1;
      color: #0c5460;
    }

    .reserva-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }

    .vuelo-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .airline-logo {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      object-fit: contain;
      background: #f5f5f5;
      padding: 5px;
    }

    .vuelo-details {
      flex: 1;
    }

    .vuelo-ruta {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .ciudad {
      font-weight: bold;
      font-size: 16px;
    }

    .aeropuerto {
      font-size: 12px;
      color: #666;
    }

    .vuelo-tiempo {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 5px;
    }

    .tiempo {
      font-weight: bold;
    }

    .duracion {
      font-size: 12px;
      color: #666;
      text-align: center;
    }

    .pasajero-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      border-left: 3px solid #8e24aa;
    }

    .pasajero-nombre {
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
      font-size: 14px;
    }

    .pasajero-details {
      font-size: 13px;
      color: #666;
    }

    .pasajero-details div {
      margin-bottom: 4px;
    }

    .reserva-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .reserva-precio {
      font-size: 18px;
      font-weight: bold;
      color: #8e24aa;
    }

    .reserva-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 12px;
      border-radius: 4px;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .btn-primary {
      background: #8e24aa;
      color: white;
    }

    .btn-primary:hover {
      background: #7b1fa2;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .btn-warning {
      background: #ffc107;
      color: #212529;
    }

    .btn-warning:hover {
      background: #e0a800;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
      background: #f8f9fa;
      border-radius: 8px;
      margin: 20px 0;
    }

    .empty-state .icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state h3 {
      margin: 0 0 10px 0;
      color: #333;
    }

    .empty-state p {
      margin: 0 0 20px 0;
      font-size: 16px;
    }

    .filtros {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .filtro-select {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      font-size: 14px;
      min-width: 180px;
    }

    .reserva-detalles {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 6px;
      margin-top: 15px;
      font-size: 14px;
      border: 1px solid #e9ecef;
    }

    .detalles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    .detalle-item {
      margin-bottom: 8px;
      padding: 8px;
      background: white;
      border-radius: 4px;
    }

    .detalle-label {
      font-weight: bold;
      color: #555;
      display: block;
      margin-bottom: 4px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detalle-value {
      color: #333;
      font-size: 14px;
    }

    .reciente-badge {
      background: #ffeb3b;
      color: #856404;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: bold;
      margin-left: 8px;
    }

    .checkin-completado {
      background: #d4edda;
      color: #155724;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      display: inline-block;
    }

    .btn-reload {
      background: #17a2b8;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-left: 10px;
    }

    .btn-reload:hover {
      background: #138496;
    }

    @media (max-width: 768px) {
      .reserva-content {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .filtros {
        flex-direction: column;
      }

      .filtro-select {
        min-width: auto;
      }

      .reserva-actions {
        flex-direction: column;
        width: 100%;
      }

      .btn-small {
        width: 100%;
        text-align: center;
      }
    }
  </style>
</head>
<body>
<div class="shell">
  <header class="header">
    <div class="brand">
      <div class="brand-badge">‚úà</div>
      <div>
        <div class="brand-title">AirTickets</div>
        <div class="brand-sub">Admin</div>
      </div>
    </div>
  </header>
  <aside class="sidebar">
    <nav class="nav">
      <a href="index.html"><span class="icon">üè†</span><span>Inicio</span></a>
      <a href="buscar.html"><span class="icon">‚úàÔ∏è</span><span>Vuelos</span></a>
      <a href="reservas.html" class="active"><span class="icon">üìñ</span><span>Reservaciones</span></a>
      <a href="aerolineas.html"><span class="icon">üõ©Ô∏è</span><span>Aerol√≠neas</span></a>
      <a href="estadisticas.html"><span class="icon">üìä</span><span>Estad√≠sticas</span></a>
      <a href="reclamos.html"><span class="icon">üí¨</span><span>Reclamos</span></a>
    </nav>
  </aside>
  <main class="content">
    <div class="card">
      <h3 class="section-title">Mis Reservas</h3>

      <!-- Filtros -->
      <div class="filtros">
        <select id="filtroEstado" class="filtro-select">
          <option value="">Todos los estados</option>
          <option value="confirmado">Confirmadas</option>
          <option value="checkin">Check-in Realizado</option>
          <option value="pendiente">Pendientes</option>
          <option value="cancelado">Canceladas</option>
        </select>

        <select id="filtroAerolinea" class="filtro-select">
          <option value="">Todas las aerol√≠neas</option>
          <option value="volaris">Volaris</option>
          <option value="iberia">Iberia</option>
          <option value="delta">Delta Air</option>
          <option value="avianca">Avianca</option>
          <option value="latam">LATAM</option>
          <option value="american">America Airlines</option>
          <option value="qatar">Qatar Air</option>
          <option value="emirates">Emirates Airways</option>
        </select>
      </div>

      <!-- Estad√≠sticas r√°pidas -->
      <div id="estadisticasReservas" style="display: none; background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <div style="display: flex; gap: 20px; font-size: 14px; flex-wrap: wrap;">
          <div><strong>Total reservas:</strong> <span id="totalReservas">0</span></div>
          <div><strong>Confirmadas:</strong> <span id="reservasConfirmadas">0</span></div>
          <div><strong>Check-in:</strong> <span id="reservasCheckin">0</span></div>
          <div><strong>Canceladas:</strong> <span id="reservasCanceladas">0</span></div>
        </div>
      </div>

      <!-- Lista de Reservas -->
      <div id="listaReservas">
        <!-- Las reservas se cargar√°n din√°micamente aqu√≠ -->
      </div>

      <!-- Estado vac√≠o -->
      <div id="emptyState" class="empty-state">
        <div class="icon">üì≠</div>
        <h3>No tienes reservas a√∫n</h3>
        <p>Cuando realices una reserva, aparecer√° aqu√≠ autom√°ticamente.</p>
        <a href="buscar.html" class="btn primary" style="margin-top: 15px; display: inline-block;">Buscar Vuelos Disponibles</a>
      </div>
    </div>
  </main>
</div>

<script>
  // Datos de aeropuertos
  const aeropuertos = [
    { code: 'BOG', city: 'Bogot√°', country: 'Colombia' },
    { code: 'MDE', city: 'Medell√≠n', country: 'Colombia' },
    { code: 'CLO', city: 'Cali', country: 'Colombia' },
    { code: 'BAQ', city: 'Barranquilla', country: 'Colombia' },
    { code: 'SAL', city: 'San Salvador', country: 'El Salvador' },
    { code: 'MIA', city: 'Miami', country: 'USA' },
    { code: 'PTY', city: 'Panama City', country: 'Panama' },
    { code: 'LAS', city: 'Las Vegas', country: 'USA' },
    { code: 'MAD', city: 'Madrid', country: 'Espa√±a' },
    { code: 'LIM', city: 'Lima', country: 'Per√∫' },
    { code: 'MEX', city: 'Ciudad de M√©xico', country: 'M√©xico' },
    { code: 'CDG', city: 'Par√≠s', country: 'Francia' },
    { code: 'JFK', city: 'Nueva York', country: 'USA' },
    { code: 'CUN', city: 'Canc√∫n', country: 'M√©xico' },
    { code: 'GDL', city: 'Guadalajara', country: 'M√©xico' },
    { code: 'TIJ', city: 'Tijuana', country: 'M√©xico' },
    { code: 'MTY', city: 'Monterrey', country: 'M√©xico' }
  ];

  // Datos de aerol√≠neas con logos (TODAS las aerol√≠neas solicitadas)
  const aerolineas = [
    {
      id: 'volaris',
      name: 'Volaris',
      logo: 'https://mir-s3-cdn-cf.behance.net/project_modules/fs_webp/6ce67d27128795.563602c83a3fc.jpg'
    },
    {
      id: 'iberia',
      name: 'Iberia',
      logo: 'https://www.marcasrenombradas.com/wp-content/uploads/2011/08/Iberia.jpg'
    },
    {
      id: 'delta',
      name: 'Delta Air',
      logo: 'https://s7d1.scene7.com/is/image/LippincottDM/Delta_03?fmt=webp&qlt=100'
    },
    {
      id: 'avianca',
      name: 'Avianca',
      logo: 'https://volavi.co/wp-content/uploads/2023/10/Nuevo-Logo_avianca-Octubre2023.jpg.webp'
    },
    {
      id: 'latam',
      name: 'LATAM',
      logo: 'https://photos.prnewswire.com/prnfull/20160428/361126LOGO'
    },
    {
      id: 'american',
      name: 'America Airlines',
      logo: 'https://assets.simpleviewinc.com/simpleview/image/upload/c_fill,h_1600,q_75,w_2400/v1/crm/tampabay/aArtboard-2_A737B76A-0BA5-49DB-F9DED6318A7C739C-a737b673bde148e_a737c1d3-f5a4-fa12-33635b09ca5fb2dd.jpg'
    },
    {
      id: 'qatar',
      name: 'Qatar Air',
      logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRD6OnNpaAsEqTYRCRYrG2qUB-ZPT9HzDiKBQ&s'
    },
    {
      id: 'emirates',
      name: 'Emirates Airways',
      logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSMWa43g3R335BROGk-pdEjAWqU6W1J9KaGlg&s'
    }
  ];

  // üî• FUNCI√ìN MEJORADA: Verificar y agregar reservas desde confirmaci√≥n
  function verificarYAgregarReservasDesdeConfirmacion() {
    console.log('üîç Verificando reservas pendientes...');

    // PRIMERO: Verificar sessionStorage (transferencia directa)
    const codigoReserva = sessionStorage.getItem('codigoReserva');
    const vueloSeleccionado = JSON.parse(sessionStorage.getItem('vueloSeleccionado') || '{}');
    const datosPasajeros = JSON.parse(sessionStorage.getItem('datosPasajeros') || '[]');
    const busqueda = JSON.parse(sessionStorage.getItem('busqueda') || '{}');
    const metodoPago = sessionStorage.getItem('metodoPago');

    let nuevaReserva = null;

    // Caso 1: Datos en sessionStorage (flujo normal)
    if (codigoReserva && vueloSeleccionado.airline) {
        console.log('üìã Datos encontrados en sessionStorage');

        // Verificar si la reserva ya existe en localStorage para evitar duplicados
        const reservasExistentes = obtenerReservas();
        const reservaExistente = reservasExistentes.find(r => r.codigo === codigoReserva);

        if (!reservaExistente) {
            // Crear nueva reserva
            nuevaReserva = {
                id: 'reserva-' + Date.now(),
                codigo: codigoReserva,
                fechaReserva: new Date().toISOString(),
                estado: 'confirmado',
                metodoPago: metodoPago || 'No especificado',
                vuelo: vueloSeleccionado,
                pasajeros: datosPasajeros,
                busqueda: busqueda,
                precioTotal: vueloSeleccionado.price ? vueloSeleccionado.price * (busqueda.numPasajeros || 1) : 850000
            };

            // Agregar a la lista de reservas
            reservasExistentes.unshift(nuevaReserva);
            const guardadoExitoso = guardarReservas(reservasExistentes);

            if (guardadoExitoso) {
                console.log('‚úÖ Nueva reserva agregada desde sessionStorage:', nuevaReserva.codigo);

                // Limpiar sessionStorage
                sessionStorage.removeItem('codigoReserva');
                sessionStorage.removeItem('vueloSeleccionado');
                sessionStorage.removeItem('datosPasajeros');
                sessionStorage.removeItem('busqueda');
                sessionStorage.removeItem('metodoPago');
            }
        } else {
            console.log('‚ÑπÔ∏è Reserva ya existe en localStorage, limpiando sessionStorage');
            sessionStorage.removeItem('codigoReserva');
            sessionStorage.removeItem('vueloSeleccionado');
            sessionStorage.removeItem('datosPasajeros');
            sessionStorage.removeItem('busqueda');
            sessionStorage.removeItem('metodoPago');
        }
    }
    // Caso 2: Verificar reservas temporales en localStorage (respaldo)
    else {
        console.log('üîç Verificando reservas temporales en localStorage...');
        const reservasTemporales = JSON.parse(localStorage.getItem('reservasTemporales') || '[]');

        if (reservasTemporales.length > 0) {
            console.log(`üì¶ Se encontraron ${reservasTemporales.length} reservas temporales`);

            const reservasExistentes = obtenerReservas();
            let reservasAgregadas = 0;

            // Procesar cada reserva temporal
            reservasTemporales.forEach(reservaTemp => {
                // Verificar si ya existe
                const existe = reservasExistentes.find(r => r.codigo === reservaTemp.codigo);

                if (!existe) {
                    // Quitar la marca temporal y agregar
                    delete reservaTemp.esTemporal;
                    reservasExistentes.unshift(reservaTemp);
                    reservasAgregadas++;
                    nuevaReserva = reservaTemp;

                    console.log('‚úÖ Reserva temporal agregada:', reservaTemp.codigo);
                }
            });

            if (reservasAgregadas > 0) {
                guardarReservas(reservasExistentes);
                console.log(`‚úÖ Se agregaron ${reservasAgregadas} reservas desde el backup`);
            }

            // Limpiar reservas temporales ya procesadas
            localStorage.removeItem('reservasTemporales');
        }
    }

    return nuevaReserva;
  }

  // Funci√≥n para obtener reservas del localStorage - MEJORADA
  function obtenerReservas() {
    try {
        const reservasGuardadas = localStorage.getItem('reservasAirTickets');
        if (reservasGuardadas) {
            const reservas = JSON.parse(reservasGuardadas);
            console.log('üìä Reservas cargadas desde localStorage:', reservas.length, 'reservas');
            return reservas;
        } else {
            console.log('‚ÑπÔ∏è No hay reservas en localStorage, creando array vac√≠o');
            return [];
        }
    } catch (error) {
        console.error('‚ùå Error al cargar reservas:', error);
        // Si hay error, devolver array vac√≠o
        return [];
    }
  }

  // Funci√≥n para guardar reservas en localStorage - MEJORADA
  function guardarReservas(reservas) {
    try {
        localStorage.setItem('reservasAirTickets', JSON.stringify(reservas));
        console.log('üíæ Reservas guardadas en localStorage:', reservas.length, 'reservas');
        return true;
    } catch (error) {
        console.error('‚ùå Error al guardar reservas en localStorage:', error);
        alert('Error al guardar las reservas. Por favor, intente nuevamente.');
        return false;
    }
  }

  // Funci√≥n para formatear fecha
  function formatearFecha(fechaISO) {
    const fecha = new Date(fechaISO);
    return fecha.toLocaleDateString('es-ES', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  // Funci√≥n para formatear m√©todo de pago
  function formatearMetodoPago(metodo) {
    const metodos = {
      'tarjeta': 'Tarjeta de Cr√©dito/D√©bito',
      'transferencia': 'Transferencia Bancaria',
      'paypal': 'PayPal',
      'efectivo': 'Pago en Efectivo'
    };
    return metodos[metodo] || metodo;
  }

  // Funci√≥n para ver si una reserva es reciente (menos de 24 horas)
  function esReservaReciente(fechaReserva) {
    const ahora = new Date();
    const fechaReservaDate = new Date(fechaReserva);
    const diferenciaHoras = (ahora - fechaReservaDate) / (1000 * 60 * 60);
    return diferenciaHoras < 24;
  }

  // Funci√≥n para redirigir a checkin.html
  function realizarCheckin(reservaId) {
    // Guardar el ID de la reserva en sessionStorage para usarlo en checkin.html
    sessionStorage.setItem('reservaCheckinId', reservaId);

    // Redirigir a la p√°gina de check-in
    window.location.href = 'checkin.html';
  }

  // Funci√≥n para cancelar reserva
  function cancelarReserva(reservaId) {
    const reservas = obtenerReservas();
    const reserva = reservas.find(r => r.id === reservaId);

    if (reserva) {
      if (reserva.estado === 'cancelado') {
        alert('‚ùå Esta reserva ya est√° cancelada.');
        return;
      }

      if (confirm(`¬øCancelar la reserva ${reserva.codigo}?\n\nEsta acci√≥n no se puede deshacer.`)) {
        reserva.estado = 'cancelado';
        reserva.fechaCancelacion = new Date().toISOString();

        guardarReservas(reservas);
        renderizarReservas(reservas);

        alert('‚ùå Reserva cancelada exitosamente.');
      }
    }
  }

  // Funci√≥n para redirigir a reclamos.html
  function hacerReclamo(reservaId) {
    // Guardar el ID de la reserva en sessionStorage para usarlo en reclamos.html
    sessionStorage.setItem('reservaReclamoId', reservaId);

    // Redirigir a la p√°gina de reclamos
    window.location.href = 'reclamos.html';
  }

  // Funci√≥n para generar y descargar PDF del ticket
  function descargarTicketPDF(reservaId) {
    const reservas = obtenerReservas();
    const reserva = reservas.find(r => r.id === reservaId);

    if (!reserva) {
      alert('‚ùå No se encontr√≥ la reserva.');
      return;
    }

    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Configuraci√≥n del documento
      doc.setFont('helvetica');
      doc.setFontSize(20);
      doc.setTextColor(26, 86, 219);
      doc.text('AirTickets - Tarjeta de Embarque', 105, 20, { align: 'center' });

      // L√≠nea separadora
      doc.setDrawColor(26, 86, 219);
      doc.setLineWidth(1);
      doc.line(20, 25, 190, 25);

      // Informaci√≥n de la reserva
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text(`C√≥digo de Reserva: ${reserva.codigo}`, 20, 35);
      doc.text(`Fecha de Emisi√≥n: ${new Date().toLocaleDateString('es-ES')}`, 20, 42);

      // Informaci√≥n del vuelo
      doc.setFontSize(14);
      doc.setTextColor(26, 86, 219);
      doc.text('INFORMACI√ìN DEL VUELO', 20, 55);

      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      let yPos = 65;

      const origenInfo = aeropuertos.find(a => a.code === reserva.vuelo.origin);
      const destinoInfo = aeropuertos.find(a => a.code === reserva.vuelo.destination);

      doc.text(`Aerol√≠nea: ${reserva.vuelo.airline}`, 20, yPos);
      doc.text(`N√∫mero de Vuelo: ${reserva.vuelo.code}`, 120, yPos);
      yPos += 7;

      doc.text(`Origen: ${origenInfo?.city || reserva.vuelo.origin} (${reserva.vuelo.origin})`, 20, yPos);
      doc.text(`Destino: ${destinoInfo?.city || reserva.vuelo.destination} (${reserva.vuelo.destination})`, 120, yPos);
      yPos += 7;

      doc.text(`Salida: ${reserva.vuelo.departureTime}`, 20, yPos);
      doc.text(`Llegada: ${reserva.vuelo.arrivalTime}`, 120, yPos);
      yPos += 7;

      doc.text(`Duraci√≥n: ${reserva.vuelo.duration}`, 20, yPos);
      if (reserva.numeroAsiento) {
        doc.text(`Asiento: ${reserva.numeroAsiento}`, 120, yPos);
      }
      yPos += 12;

      // Informaci√≥n del pasajero
      doc.setFontSize(14);
      doc.setTextColor(26, 86, 219);
      doc.text('INFORMACI√ìN DEL PASAJERO', 20, yPos);

      doc.setFontSize(10);
      doc.setTextColor(0, 0, 0);
      yPos += 10;

      doc.text(`Nombre: ${reserva.pasajeros[0]?.nombre}`, 20, yPos);
      yPos += 7;

      doc.text(`Pasaporte: ${reserva.pasajeros[0]?.pasaporte}`, 20, yPos);
      yPos += 7;

      if (reserva.busqueda?.fecha) {
        doc.text(`Fecha de Vuelo: ${formatearFecha(reserva.busqueda.fecha)}`, 20, yPos);
      }
      yPos += 12;

      // C√≥digo de barras simulado
      doc.setFontSize(8);
      doc.setTextColor(100, 100, 100);
      doc.text('C√≥digo de embarque (presentar en aeropuerto):', 20, yPos);
      yPos += 5;

      // Simular c√≥digo de barras con l√≠neas
      for (let i = 0; i < 50; i++) {
        const altura = Math.random() * 10 + 5;
        doc.line(20 + (i * 3), yPos, 20 + (i * 3), yPos + altura);
      }
      yPos += 20;

      // Informaci√≥n importante
      doc.setFontSize(8);
      doc.setTextColor(150, 150, 150);
      doc.text('‚Ä¢ Llegar al aeropuerto 2 horas antes del vuelo internacional', 20, yPos);
      yPos += 4;
      doc.text('‚Ä¢ Presentar este documento y pasaporte en el mostrador', 20, yPos);
      yPos += 4;
      doc.text('‚Ä¢ El check-in cierra 45 minutos antes de la salida', 20, yPos);

      // Pie de p√°gina
      doc.setFontSize(8);
      doc.setTextColor(150, 150, 150);
      doc.text('AirTickets - Sistema de Reservas de Vuelos', 105, 280, { align: 'center' });
      doc.text('www.airtickets.com - servicio@airtickets.com', 105, 285, { align: 'center' });

      // Guardar el PDF
      const nombreArchivo = `Ticket_${reserva.codigo}.pdf`;
      doc.save(nombreArchivo);

      console.log('‚úÖ Ticket PDF generado y descargado exitosamente');

    } catch (error) {
      console.error('‚ùå Error al generar PDF:', error);
      alert('‚ùå Error al generar el ticket. Intente nuevamente.');
    }
  }

  // Funci√≥n para renderizar reservas
  function renderizarReservas(reservas) {
    const listaReservas = document.getElementById('listaReservas');
    const emptyState = document.getElementById('emptyState');
    const estadisticas = document.getElementById('estadisticasReservas');

    if (reservas.length === 0) {
      listaReservas.innerHTML = '';
      emptyState.style.display = 'block';
      estadisticas.style.display = 'none';
      return;
    }

    emptyState.style.display = 'none';
    estadisticas.style.display = 'block';
    listaReservas.innerHTML = '';

    // Actualizar estad√≠sticas
    const totalReservas = reservas.length;
    const reservasConfirmadas = reservas.filter(r => r.estado === 'confirmado').length;
    const reservasCheckin = reservas.filter(r => r.estado === 'checkin').length;
    const reservasCanceladas = reservas.filter(r => r.estado === 'cancelado').length;

    document.getElementById('totalReservas').textContent = totalReservas;
    document.getElementById('reservasConfirmadas').textContent = reservasConfirmadas;
    document.getElementById('reservasCheckin').textContent = reservasCheckin;
    document.getElementById('reservasCanceladas').textContent = reservasCanceladas;

    reservas.forEach((reserva) => {
      const origenInfo = aeropuertos.find(a => a.code === reserva.vuelo.origin);
      const destinoInfo = aeropuertos.find(a => a.code === reserva.vuelo.destination);
      const aerolineaInfo = aerolineas.find(a => a.id === reserva.vuelo.airlineId);
      const esReciente = esReservaReciente(reserva.fechaReserva);

      const reservaCard = document.createElement('div');
      reservaCard.className = 'reserva-card';

      // Determinar botones disponibles seg√∫n el estado
      let botonesAccion = '';
      if (reserva.estado === 'confirmado') {
        botonesAccion = `
          <button class="btn-small btn-success" onclick="realizarCheckin('${reserva.id}')">Check-in</button>
          <button class="btn-small btn-warning" onclick="hacerReclamo('${reserva.id}')">Reclamo</button>
          <button class="btn-small btn-danger" onclick="cancelarReserva('${reserva.id}')">Cancelar</button>
          <button class="btn-small btn-primary" onclick="descargarTicketPDF('${reserva.id}')">Descargar Ticket</button>
        `;
      } else if (reserva.estado === 'checkin') {
        botonesAccion = `
          <span class="checkin-completado">‚úì Check-in Realizado</span>
          <button class="btn-small btn-warning" onclick="hacerReclamo('${reserva.id}')">Reclamo</button>
          <button class="btn-small btn-primary" onclick="descargarTicketPDF('${reserva.id}')">Descargar Ticket</button>
        `;
      } else if (reserva.estado === 'cancelado') {
        botonesAccion = `
          <span class="checkin-completado" style="background: #f8d7da; color: #721c24;">‚úó Reserva Cancelada</span>
          <button class="btn-small btn-warning" onclick="hacerReclamo('${reserva.id}')">Reclamo</button>
        `;
      }

      reservaCard.innerHTML = `
        <div class="reserva-header">
          <div>
            <span class="reserva-codigo">Reserva #${reserva.codigo}</span>
            ${esReciente ? '<span class="reciente-badge">NUEVA</span>' : ''}
          </div>
          <div class="reserva-estado estado-${reserva.estado}">
            ${reserva.estado === 'confirmado' ? '‚úÖ Confirmada' :
              reserva.estado === 'checkin' ? 'üé´ Check-in Realizado' :
              reserva.estado === 'cancelado' ? '‚ùå Cancelada' : '‚è≥ Pendiente'}
          </div>
        </div>

        <div class="reserva-content">
          <div class="vuelo-info">
            <img src="${aerolineaInfo?.logo || ''}" alt="${reserva.vuelo.airline}" class="airline-logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIGZpbGw9IiNmNWY1ZjUiLz48dGV4dCB4PSIyMCIgeT0iMjIiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NiI+4pawPC90ZXh0Pjwvc3ZnPg=='">
            <div class="vuelo-details">
              <div class="vuelo-ruta">
                <div>
                  <div class="ciudad">${origenInfo?.city || reserva.vuelo.origin}</div>
                  <div class="aeropuerto">${reserva.vuelo.origin}</div>
                </div>
                <div style="text-align: center; flex: 1;">
                  <div style="font-size: 12px; color: #666;">${reserva.vuelo.duration}</div>
                  <div style="border-bottom: 2px solid #ddd; margin: 5px 0; position: relative;">
                    <span style="background: white; padding: 0 5px; position: relative; top: -2px;">‚úàÔ∏è</span>
                  </div>
                </div>
                <div style="text-align: right;">
                  <div class="ciudad">${destinoInfo?.city || reserva.vuelo.destination}</div>
                  <div class="aeropuerto">${reserva.vuelo.destination}</div>
                </div>
              </div>

              <div class="vuelo-tiempo">
                <div>
                  <div class="tiempo">${reserva.vuelo.departureTime}</div>
                  <div style="font-size: 12px; color: #666;">Salida</div>
                </div>
                <div class="duracion">${reserva.vuelo.duration}</div>
                <div style="text-align: right;">
                  <div class="tiempo">${reserva.vuelo.arrivalTime}</div>
                  <div style="font-size: 12px; color: #666;">Llegada</div>
                </div>
              </div>

              <div style="font-size: 12px; color: #666; margin-top: 5px;">
                ${reserva.vuelo.airline} ‚Ä¢ ${reserva.vuelo.code} ‚Ä¢ ${reserva.vuelo.aircraft}
                ${reserva.numeroAsiento ? `‚Ä¢ Asiento: ${reserva.numeroAsiento}` : ''}
              </div>
            </div>
          </div>

          <div class="pasajero-info">
            <div class="pasajero-nombre">${reserva.pasajeros[0]?.nombre || 'Pasajero principal'}</div>
            <div class="pasajero-details">
              <div><strong>Pasaporte:</strong> ${reserva.pasajeros[0]?.pasaporte || 'No especificado'}</div>
              <div><strong>Asiento:</strong> ${reserva.pasajeros[0]?.preferenciaAsiento || 'Por asignar'}</div>
              <div><strong>Pago:</strong> ${formatearMetodoPago(reserva.metodoPago)}</div>
              ${reserva.fechaCheckin ? `<div><strong>Check-in:</strong> ${formatearFecha(reserva.fechaCheckin)}</div>` : ''}
            </div>
          </div>
        </div>

        <div class="reserva-detalles" id="detalles-${reserva.id}" style="display: none;">
          <div class="detalles-grid">
            <div class="detalle-item">
              <span class="detalle-label">Fecha de reserva</span>
              <span class="detalle-value">${formatearFecha(reserva.fechaReserva)}</span>
            </div>
            <div class="detalle-item">
              <span class="detalle-label">N√∫mero de pasajeros</span>
              <span class="detalle-value">${reserva.pasajeros.length}</span>
            </div>
            <div class="detalle-item">
              <span class="detalle-label">Tipo de vuelo</span>
              <span class="detalle-value">${reserva.vuelo.escala ? 'Con escala' : 'Directo'}</span>
            </div>
            <div class="detalle-item">
              <span class="detalle-label">Fecha de vuelo</span>
              <span class="detalle-value">${reserva.busqueda?.fecha ? formatearFecha(reserva.busqueda.fecha) : 'No especificada'}</span>
            </div>
            <div class="detalle-item">
              <span class="detalle-label">M√©todo de pago</span>
              <span class="detalle-value">${formatearMetodoPago(reserva.metodoPago)}</span>
            </div>
            <div class="detalle-item">
              <span class="detalle-label">Precio total</span>
              <span class="detalle-value">$${reserva.precioTotal.toLocaleString()}</span>
            </div>
          </div>
        </div>

        <div class="reserva-footer">
          <div class="reserva-precio">$${reserva.precioTotal.toLocaleString()}</div>
          <div class="reserva-actions">
            <button class="btn-small btn-secondary" onclick="toggleDetalles('${reserva.id}')">Ver detalles</button>
            ${botonesAccion}
          </div>
        </div>
      `;

      listaReservas.appendChild(reservaCard);
    });
  }

  // Funci√≥n para mostrar/ocultar detalles
  function toggleDetalles(reservaId) {
    const detalles = document.getElementById(`detalles-${reservaId}`);
    const boton = document.querySelector(`button[onclick="toggleDetalles('${reservaId}')"]`);

    const estaVisible = detalles.style.display === 'block';

    detalles.style.display = estaVisible ? 'none' : 'block';
    boton.textContent = estaVisible ? 'Ver detalles' : 'Ocultar detalles';
  }

  // Funci√≥n para aplicar filtros (simplificada)
  function aplicarFiltros() {
    const filtroEstado = document.getElementById('filtroEstado').value;
    const filtroAerolinea = document.getElementById('filtroAerolinea').value;

    let reservas = obtenerReservas();

    if (filtroEstado) {
      reservas = reservas.filter(r => r.estado === filtroEstado);
    }

    if (filtroAerolinea) {
      reservas = reservas.filter(r => r.vuelo.airlineId === filtroAerolinea);
    }

    renderizarReservas(reservas);
  }

  // Funci√≥n para verificar el estado de las reservas
  function verificarEstadoReservas() {
    const reservas = obtenerReservas();
    console.log('üìä Estado actual de reservas:', {
        total: reservas.length,
        reservas: reservas.map(r => ({ codigo: r.codigo, estado: r.estado }))
    });

    // Mostrar notificaci√≥n si no hay reservas
    if (reservas.length === 0) {
        console.log('‚ÑπÔ∏è No hay reservas en el sistema');
    }

    return reservas;
  }

  // Funci√≥n para forzar la recarga de reservas
  function forzarRecargaReservas() {
    console.log('üîÑ Forzando recarga de reservas...');

    // Verificar sessionStorage nuevamente
    const codigoReserva = sessionStorage.getItem('codigoReserva');
    if (codigoReserva) {
        console.log('üîÑ Se encontraron datos en sessionStorage, reprocesando...');
        verificarYAgregarReservasDesdeConfirmacion();
    }

    // Recargar la vista
    const reservas = obtenerReservas();
    renderizarReservas(reservas);

    alert('‚úÖ Reservas actualizadas');
  }

  // Funci√≥n para agregar bot√≥n de recarga
  function agregarBotonRecarga() {
    const card = document.querySelector('.card');
    const existingButton = document.querySelector('.btn-reload');

    if (!existingButton) {
        const botonRecarga = document.createElement('button');
        botonRecarga.textContent = 'üîÑ Actualizar Reservas';
        botonRecarga.className = 'btn-reload';
        botonRecarga.style.marginTop = '10px';
        botonRecarga.onclick = forzarRecargaReservas;

        card.appendChild(botonRecarga);
    }
  }

  // üîÑ INICIALIZACI√ìN MEJORADA
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ Iniciando carga MEJORADA de reservas...');

    // PRIMERO: Verificar y agregar reservas desde confirmaci√≥n
    const nuevaReserva = verificarYAgregarReservasDesdeConfirmacion();

    // SEGUNDO: Verificar estado actual
    const reservas = verificarEstadoReservas();

    // TERCERO: Mostrar reservas
    console.log('üìä Total de reservas a mostrar:', reservas.length);
    reservas.sort((a, b) => new Date(b.fechaReserva) - new Date(a.fechaReserva));
    renderizarReservas(reservas);

    // CUARTO: Configurar eventos
    document.getElementById('filtroEstado').addEventListener('change', aplicarFiltros);
    document.getElementById('filtroAerolinea').addEventListener('change', aplicarFiltros);

    // QUINTO: Mostrar notificaci√≥n si se agreg√≥ nueva reserva
    if (nuevaReserva) {
        setTimeout(() => {
            alert(`‚úÖ ¬°Nueva reserva agregada!\nC√≥digo: ${nuevaReserva.codigo}\nVuelo: ${nuevaReserva.vuelo.code}`);
        }, 1000);
    }

    // SEXTO: Agregar bot√≥n de recarga manual
    agregarBotonRecarga();
  });

  // Funci√≥n para agregar reserva de ejemplo (para testing)
  function agregarReservaEjemplo() {
    const aerolineasEjemplo = ['volaris', 'iberia', 'delta', 'avianca', 'latam', 'american', 'qatar', 'emirates'];
    const aerolineaAleatoria = aerolineasEjemplo[Math.floor(Math.random() * aerolineasEjemplo.length)];
    const aerolineaInfo = aerolineas.find(a => a.id === aerolineaAleatoria);

    const reservaEjemplo = {
      id: 'ejemplo-' + Date.now(),
      codigo: 'R' + Math.random().toString(36).substring(2, 8).toUpperCase(),
      fechaReserva: new Date().toISOString(),
      estado: 'confirmado',
      metodoPago: 'tarjeta',
      vuelo: {
        airline: aerolineaInfo.name,
        airlineId: aerolineaInfo.id,
        code: `${aerolineaInfo.id.substring(0, 2).toUpperCase()}-${Math.floor(Math.random() * 900) + 100}`,
        aircraft: 'Boeing 737-800',
        origin: 'BOG',
        destination: 'MDE',
        departureTime: '14:30',
        arrivalTime: '15:45',
        duration: '1h 15m',
        price: 350000,
        flightType: 'directo'
      },
      pasajeros: [{
        nombre: 'Juan P√©rez',
        fechaNacimiento: '1990-05-15',
        pasaporte: 'AB123456',
        preferenciaAsiento: 'Ventana',
        email: 'juan@example.com',
        telefono: '+57 300 123 4567'
      }],
      busqueda: {
        fecha: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // 7 d√≠as en el futuro
        numPasajeros: 1
      },
      precioTotal: 350000
    };

    const reservas = obtenerReservas();
    reservas.unshift(reservaEjemplo);
    guardarReservas(reservas);
    renderizarReservas(reservas);

    alert('Reserva de ejemplo agregada correctamente');
  }
</script>
</body>
</html>