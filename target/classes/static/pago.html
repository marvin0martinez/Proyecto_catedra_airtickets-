<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AirTickets - Pago</title>
  <link rel="stylesheet" href="assets/styles.css" />
  <style>
    .flight-details {
      display: none;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
    }
    .flight-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .flight-airline-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .airline-logo {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      object-fit: contain;
    }
    .flight-airline {
      font-weight: 600;
      font-size: 18px;
      color: #1a56db;
    }
    .flight-price {
      font-weight: 800;
      font-size: 22px;
      color: #16a34a;
    }
    .flight-route {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .flight-times {
      display: flex;
      align-items: center;
      gap: 20px;
      width: 100%;
      justify-content: center;
    }
    .flight-time {
      text-align: center;
      flex: 1;
    }
    .time-main {
      font-weight: 700;
      font-size: 16px;
    }
    .time-city {
      font-size: 12px;
      color: #666;
    }
    .flight-duration {
      text-align: center;
      color: #666;
      font-size: 12px;
      min-width: 80px;
    }
    .flight-info {
      display: flex;
      gap: 16px;
      margin-top: 8px;
      font-size: 12px;
      color: #666;
      flex-wrap: wrap;
    }
    .flight-info-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .required-field::after {
      content: " *";
      color: #dc2626;
    }
    .flight-type-badge {
      background: #e0f2fe;
      color: #0369a1;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      margin-left: 8px;
    }
    .flight-combined {
      background: #f0f9ff;
      border-left: 3px solid #0ea5e9;
    }
    .flight-code-display {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    .passenger-info {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid #e9ecef;
    }
    .passenger-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    .passenger-item {
      display: flex;
      flex-direction: column;
    }
    .passenger-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .passenger-value {
      font-weight: 600;
      font-size: 14px;
    }

    /* Estilos para m√©todos de pago */
    .payment-method-option {
      display: none;
    }
    .payment-method-option.active {
      display: block;
    }
    .payment-method-icon {
      width: 24px;
      height: 24px;
      margin-right: 8px;
    }
    .payment-method-label {
      display: flex;
      align-items: center;
    }

    /* Estilos para la informaci√≥n de aerol√≠nea en pago efectivo */
    #cashAirlineInfo {
      border-left: 4px solid #0ea5e9;
      background: #f0f9ff;
    }
    .payment-method-option {
      transition: all 0.3s ease-in-out;
    }
    /* Destacar la secci√≥n de pago en efectivo cuando est√° activa */
    #cashFields.active {
      background: #f8fafc;
      border-radius: 8px;
      padding: 16px;
      border: 1px solid #e2e8f0;
    }
    .cash-success {
      background: #d1fae5;
      border: 1px solid #a7f3d0;
      color: #065f46;
      padding: 12px;
      border-radius: 6px;
      margin-top: 12px;
    }
    html,body{height:auto}

    /* === Tarjeta 3D === */
    .stage{perspective:1200px; margin-bottom:16px}
    .card3d{width: 420px; height: 260px; border-radius: 18px; position:relative; margin: 8px 0 18px; transform-style:preserve-3d; transition:transform 600ms cubic-bezier(.2,.7,.2,1); box-shadow: 0 24px 60px rgba(0,0,0,.35), 0 6px 18px rgba(0,0,0,.4)}
    .card3d.flip{ transform: rotateY(180deg); }
    .tiltable{ --rx:0deg; --ry:0deg; --tz:0px; transform: rotateX(var(--rx)) rotateY(var(--ry)) translateZ(var(--tz)); }

    .face{position:absolute; inset:0; border-radius:18px; overflow:hidden; backface-visibility:hidden; background: linear-gradient(135deg,#1d2242,#2e3a83); }
    .front{ padding:22px 26px; display:flex; flex-direction:column; justify-content:space-between }
    .back{ transform: rotateY(180deg); padding:18px }
    .gloss{position:absolute; inset:-1px; background: linear-gradient(160deg, rgba(255,255,255,.08), rgba(255,255,255,0) 40%); mix-blend-mode:screen; pointer-events:none}
    .row.top{display:flex; align-items:center; justify-content:space-between}
    .brand{font-weight:800; letter-spacing:.6px; color:#d4e3ff}
    .chip{width:58px;height:42px;border-radius:8px;background:linear-gradient(180deg,#d9d9d9,#bdbdbd);position:relative;box-shadow:inset 0 0 0 2px rgba(0,0,0,.15)}
    .chip:before,.chip:after{content:"";position:absolute;background:#9aa0a6}
    .chip:before{inset:10px 8px 10px 30px;border-radius:3px}
    .chip:after{width:22px;height:22px;border-radius:50%;left:8px;top:10px;box-shadow:0 22px 0 0 #9aa0a6}

    .cardnum{font-size:28px; letter-spacing:2px; font-weight:700; display:flex; gap:8px; flex-wrap:wrap; color:#eaf1ff}
    .cardnum .group{min-width:60px; text-align:center}
    .labels{display:flex; justify-content:space-between; gap:16px}
    .labcol{display:flex; flex-direction:column; gap:6px; min-width:46%}
    .muted{font-size:12px; letter-spacing:.6px; color:#a8b3d1}
    .value{font-size:16px; letter-spacing:.5px; font-weight:700; color:#eaf1ff}

    .mag{height:56px;background:#000;border-radius:8px;margin-top:12px}
    .sig{margin:20px 0 0; display:flex; align-items:center; gap:10px}
    .sig label{font-size:12px;color:#ccd}
    .sig .strip{flex:1; height:26px; background:repeating-linear-gradient(90deg,#e8edf7 0,#f9fbff 6px,#e8edf7 12px); border-radius:4px}
    .cvcbox{margin-left:auto;font-weight:800;letter-spacing:2px; color:#223; background:#f0f3f8; padding:6px 10px; border-radius:6px}

    .help{font-size:12px;color:#6b7280}
    @media (max-width: 480px){ .card3d{transform: scale(.9); transform-origin:left top} }
  </style>
</head>
<body>
<div class="shell">
  <header class="header">
    <div class="brand">
      <div class="brand-badge">‚úà</div>
      <div>
        <div class="brand-title">AirTickets</div>
        <div class="brand-sub">Admin</div>
      </div>
    </div>
  </header>
  <aside class="sidebar">
    <nav class="nav">
      <a href="index.html" class=""><span class="icon">üè†</span><span>Inicio</span></a>
      <a href="buscar.html" class="active"><span class="icon">‚úàÔ∏è</span><span>Vuelos</span></a>
      <a href="reservas.html" class=""><span class="icon">üìñ</span><span>Reservaciones</span></a>
      <a href="aerolineas.html" class=""><span class="icon">üõ©Ô∏è</span><span>Aerol√≠neas</span></a>
      <a href="estadisticas.html" class=""><span class="icon">üìä</span><span>Estad√≠sticas</span></a>
      <a href="reclamos.html" class=""><span class="icon">üí¨</span><span>Reclamos</span></a>
    </nav>
  </aside>
  <main class="content">
    <div class="card">
      <h3 class="section-title">Informaci√≥n de Pago</h3>

      <!-- Informaci√≥n del vuelo -->
      <div id="flightDetails" class="flight-details">
        <div class="flight-header">
          <div class="flight-airline-info">
            <img id="airlineLogo" class="airline-logo" src="" alt="Logo aerol√≠nea">
            <div>
              <div class="flight-airline" id="flightAirline">Cargando informaci√≥n del vuelo...</div>
              <div class="flight-code-display" id="flightCode">C√≥digo: -</div>
            </div>
          </div>
          <div class="flight-price" id="flightPrice">-</div>
        </div>
        <div class="flight-route">
          <div class="flight-times">
            <div class="flight-time">
              <div class="time-main" id="departureTime">--:--</div>
              <div class="time-city" id="originCity">Origen</div>
            </div>
            <div class="flight-duration">
              <div>‚è±</div>
              <div id="flightDuration">-</div>
            </div>
            <div class="flight-time">
              <div class="time-main" id="arrivalTime">--:--</div>
              <div class="time-city" id="destinationCity">Destino</div>
            </div>
          </div>
        </div>
        <div class="flight-info">
          <div class="flight-info-item">
            <span>üõ©Ô∏è</span>
            <span id="flightAircraft">Avi√≥n: -</span>
          </div>
          <div class="flight-info-item">
            <span>üë•</span>
            <span id="flightPassengers">Pasajeros: -</span>
          </div>
          <div class="flight-info-item">
            <span>üìÖ</span>
            <span id="flightDate">Fecha: -</span>
          </div>
          <div id="flightTypeBadge" class="flight-info-item"></div>
        </div>
        <div id="additionalInfo" class="flight-info"></div>
      </div>

      <!-- Informaci√≥n del pasajero -->
      <div id="passengerInfo" class="passenger-info">
        <h4 style="margin: 0 0 12px 0;">Informaci√≥n del Pasajero</h4>
        <div class="passenger-details">
          <div class="passenger-item">
            <div class="passenger-label">Nombre Completo</div>
            <div class="passenger-value" id="passengerName">-</div>
          </div>
          <div class="passenger-item">
            <div class="passenger-label">Fecha de Nacimiento</div>
            <div class="passenger-value" id="passengerBirthDate">-</div>
          </div>
          <div class="passenger-item">
            <div class="passenger-label">N√∫mero de Pasaporte</div>
            <div class="passenger-value" id="passengerPassport">-</div>
          </div>
          <div class="passenger-item">
            <div class="passenger-label">Preferencia de Asiento</div>
            <div class="passenger-value" id="passengerSeatPreference">-</div>
          </div>
        </div>
      </div>

      <form id="paymentForm">
        <div class="form-row">
          <div>
            <div class="label required-field">M√©todo de Pago</div>
            <select id="paymentMethod" class="select" required>
              <option value="">Seleccione m√©todo de pago</option>
              <option value="tarjeta">Tarjeta de Cr√©dito/D√©bito</option>
              <option value="efectivo">Pago en Efectivo</option>
            </select>
          </div>

          <!-- Campos para tarjeta -->
          <div id="cardFields" class="payment-method-option">
            <!-- Tarjeta 3D interactiva -->
            <div id="card3dStage" class="stage">
              <div id="card3d" class="card3d tiltable">
                <!-- Cara frontal -->
                <div class="face front">
                  <div class="row top">
                    <div class="chip"></div>
                    <div class="brand" id="brandTxt">GENERIC</div>
                  </div>

                  <div class="cardnum" id="numDisplay">
                    <span class="group" id="g1">####</span>
                    <span class="group" id="g2">####</span>
                    <span class="group" id="g3">####</span>
                    <span class="group" id="g4">####</span>
                  </div>

                  <div class="labels">
                    <div class="labcol">
                      <div class="muted">TITULAR</div>
                      <div class="value" id="holderDisplay">NOMBRE APELLIDO</div>
                    </div>
                    <div class="labcol">
                      <div class="muted">VENCE</div>
                      <div class="value" id="expDisplay">MM/AA</div>
                    </div>
                  </div>
                  <div class="gloss"></div>
                </div>

                <!-- Cara trasera -->
                <div class="face back">
                  <div class="mag"></div>
                  <div class="sig">
                    <label>Firma</label>
                    <div class="strip"></div>
                    <div class="cvcbox" id="cvcDisplay">‚Ä¢‚Ä¢‚Ä¢</div>
                  </div>
                  <div class="gloss"></div>
                </div>
              </div>
              <div class="help">Tip: al enfocar el CVC, la tarjeta gira. Mueve el mouse para tilt ‚ú®</div>
            </div>

            <div>
              <div class="label required-field">N√∫mero de Tarjeta</div>
              <input id="cardNumber" class="input" placeholder="1234 5678 9012 3456" maxlength="19" required />
            </div>
            <div>
              <div class="label required-field">Fecha de Vencimiento</div>
              <input id="cardExpiry" class="input" placeholder="MM/AA" maxlength="7" required />
            </div>
            <div>
              <div class="label required-field">CVV</div>
              <input id="cardCVV" class="input" placeholder="123" maxlength="4" required />
            </div>
            <div>
              <div class="label required-field">Nombre del Titular</div>
              <input id="cardHolder" class="input" placeholder="Como aparece en la tarjeta" required />
            </div>
          </div>

          <!-- Campos para pago en efectivo -->
          <div id="cashFields" class="payment-method-option">
            <div>
              <div class="label">Para completar tu reserva, deber√°s acercarte a cualquier oficina de la aerol√≠nea para realizar el pago en efectivo.</div>
            </div>

            <!-- Informaci√≥n de la aerol√≠nea del vuelo seleccionado -->
            <div id="cashAirlineInfo" style="padding: 16px; border-radius: 6px; margin: 12px 0;">
              <div style="font-weight: 600; margin-bottom: 8px; color: #0369a1;">‚úàÔ∏è Aerol√≠nea para pago en efectivo:</div>
              <div id="selectedAirlineName" style="font-size: 16px; font-weight: 600; color: #1e40af;"></div>
              <div style="font-size: 14px; color: #666; margin-top: 8px;">
                üíµ <strong>Pagar√°s en efectivo en:</strong> Oficinas de <span id="airlinePaymentName" style="font-weight: 600;"></span>
              </div>
            </div>

            <div class="cash-success">
              <div style="font-weight: 600; margin-bottom: 8px;">‚úÖ Informaci√≥n importante:</div>
              <div style="font-size: 14px;">
                ‚Ä¢ Presenta tu documento de identificaci√≥n y c√≥digo de reserva<br>
                ‚Ä¢ Tienes 24 horas para realizar el pago<br>
                ‚Ä¢ Puedes pagar en cualquier oficina de la aerol√≠nea<br>
                ‚Ä¢ Tu reserva se confirmar√° autom√°ticamente al pagar
              </div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:16px">
          <a class="btn secondary" href="resumen.html">Volver</a>
          <button type="submit" class="btn right">Confirmar Pago</button>
        </div>
      </form>
    </div>
  </main>
</div>

<script>
  // Datos de aeropuertos
  const aeropuertos = [
    { code: 'BOG', city: 'Bogot√°', country: 'Colombia' },
    { code: 'MDE', city: 'Medell√≠n', country: 'Colombia' },
    { code: 'CLO', city: 'Cali', country: 'Colombia' },
    { code: 'BAQ', city: 'Barranquilla', country: 'Colombia' },
    { code: 'SAL', city: 'San Salvador', country: 'El Salvador' },
    { code: 'MIA', city: 'Miami', country: 'USA' },
    { code: 'PTY', city: 'Panama City', country: 'Panama' },
    { code: 'LAS', city: 'Las Vegas', country: 'USA' },
    { code: 'MAD', city: 'Madrid', country: 'Espa√±a' },
    { code: 'LIM', city: 'Lima', country: 'Per√∫' },
    { code: 'MEX', city: 'Ciudad de M√©xico', country: 'M√©xico' },
    { code: 'CDG', city: 'Par√≠s', country: 'Francia' },
    { code: 'JFK', city: 'Nueva York', country: 'USA' },
    { code: 'CUN', city: 'Canc√∫n', country: 'M√©xico' },
    { code: 'GDL', city: 'Guadalajara', country: 'M√©xico' },
    { code: 'TIJ', city: 'Tijuana', country: 'M√©xico' },
    { code: 'MTY', city: 'Monterrey', country: 'M√©xico' }
  ];

  // Datos de aerol√≠neas con logos
  const aerolineas = [
    { id: 'delta',   name: 'Delta Air',          logo: 'https://s7d1.scene7.com/is/image/LippincottDM/Delta_03?fmt=webp&qlt=100' },
    { id: 'avianca', name: 'Avianca',            logo: 'https://volavi.co/wp-content/uploads/2023/10/Nuevo-Logo_avianca-Octubre2023.jpg.webp' },
    { id: 'latam',   name: 'LATAM',              logo: 'https://photos.prnewswire.com/prnfull/20160428/361126LOGO' },
    { id: 'iberia',  name: 'Iberia',             logo: 'https://www.marcasrenombradas.com/wp-content/uploads/2011/08/Iberia.jpg' },
    { id: 'american',name: 'America Airlines',   logo: 'https://assets.simpleviewinc.com/simpleview/image/upload/c_fill,h_1600,q_75,w_2400/v1/crm/tampabay/aArtboard-2_A737B76A-0BA5-49DB-F9DED6318A7C739C-a737b673bde148e_a737c1d3-f5a4-fa12-33635b09ca5fb2dd.jpg' },
    { id: 'qatar',   name: 'Qatar Air',          logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRD6OnNpaAsEqTYRCRYrG2qUB-ZPT9HzDiKBQ&s' },
    { id: 'emirates',name: 'Emirates Airways',   logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSMWa43g3R335BROGk-pdEjAWqU6W1J9KaGlg&s' },
    { id: 'volaris', name: 'Volaris',            logo: 'https://mir-s3-cdn-cf.behance.net/project_modules/fs_webp/6ce67d27128795.563602c83a3fc.jpg' }
  ];

  // Funci√≥n para obtener el vuelo seleccionado
  function obtenerVueloSeleccionado(flightId) {
    console.log('üîç Buscando vuelo con ID:', flightId);
    const vueloGuardado = sessionStorage.getItem('vueloSeleccionado');
    if (vueloGuardado) {
      try {
        const vuelos = JSON.parse(vueloGuardado);
        console.log('üì¶ Vuelos encontrados en sessionStorage:', vuelos);
        let vueloEncontrado = null;

        if (String(flightId || '').startsWith('combinado-')) {
          vueloEncontrado = vuelos.find(v => v.id === flightId);
        } else {
          vueloEncontrado = vuelos.find(v => {
            if (v.id && typeof v.id === 'string' && v.id.startsWith('combinado-')) return false;
            const vueloId = parseInt(v.id);
            const searchId = parseInt(flightId);
            return vueloId === searchId;
          });
        }

        if (vueloEncontrado) return vueloEncontrado;
        console.log('‚ö†Ô∏è No se encontr√≥ el vuelo espec√≠fico, usando el primero disponible');
        return vuelos[0];
      } catch (error) {
        console.error('‚ùå Error al parsear vuelos:', error);
      }
    }

    // Datos de prueba
    console.log('üîÑ Usando datos de prueba');
    const vuelosPrueba = [
      { id: 1, code: 'AV-101', airline: 'Avianca', airlineId: 'avianca', aircraft: 'Boeing 787-8 Dreamliner', origin: 'BOG', destination: 'MAD', departureTime: '14:30', arrivalTime: '06:45', duration: '9h 15m', price: 1850000, availableSeats: 45, flightType: 'directo' },
      { id: 2, code: 'IB-609', airline: 'Iberia',  airlineId: 'iberia',  aircraft: 'Airbus A350-900',          origin: 'MAD', destination: 'MEX', departureTime: '22:15', arrivalTime: '14:30', duration: '12h 15m', price: 2920000, availableSeats: 28, flightType: 'directo' }
    ];
    return vuelosPrueba.find(v => v.id.toString() === String(flightId)) || vuelosPrueba[0];
  }

  // === Formateos existentes ===
  function formatearNumeroTarjeta(input) {
    let value = input.value.replace(/\s+/g, '');
    let formattedValue = '';
    for (let i = 0; i < value.length; i++) {
      if (i > 0 && i % 4 === 0) formattedValue += ' ';
      formattedValue += value[i];
    }
    input.value = formattedValue;
  }
  function formatearFechaVencimiento(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length >= 2) value = value.substring(0, 2) + '/' + value.substring(2, 6);
    input.value = value;
  }

  // === 3D Card utilities ===
  function detectBrand(numDigits){
    const n = numDigits;
    if (/^4/.test(n)) return 'VISA';
    if (/^(5[1-5]|2[2-7])/.test(n)) return 'MASTERCARD';
    if (/^3[47]/.test(n)) return 'AMEX';
    return 'GENERIC';
  }
  function splitGroups(numDigits){
    const clean = (numDigits || '').replace(/\D/g,'').slice(0,19);
    const padded = (clean + '###################').slice(0,16);
    return [0,4,8,12].map(i => padded.slice(i, i+4).replace(/ /g,'#'));
  }
  function renderCard3D(){
    const numInput = document.getElementById('cardNumber');
    const holderInput = document.getElementById('cardHolder');
    const expInput = document.getElementById('cardExpiry');
    const cvcInput = document.getElementById('cardCVV');

    const digits = (numInput?.value || '').replace(/\s/g,'').replace(/\D/g,'');
    const [g1,g2,g3,g4] = splitGroups(digits);
    const brand = detectBrand(digits);
    const brandEl = document.getElementById('brandTxt');
    if (brandEl) brandEl.textContent = brand;

    const el = id => document.getElementById(id);
    if (el('g1')) el('g1').textContent = g1 || '####';
    if (el('g2')) el('g2').textContent = g2 || '####';
    if (el('g3')) el('g3').textContent = g3 || '####';
    if (el('g4')) el('g4').textContent = g4 || '####';

    if (el('holderDisplay')) el('holderDisplay').textContent = (holderInput?.value || '').trim() || 'NOMBRE APELLIDO';
    if (el('expDisplay')) el('expDisplay').textContent = (expInput?.value || '').toUpperCase() || 'MM/AA';

    const cvc = (cvcInput?.value || '').replace(/\D/g,'').slice(0,4);
    if (el('cvcDisplay')) el('cvcDisplay').textContent = cvc ? cvc : '‚Ä¢‚Ä¢‚Ä¢';
  }
  function attachFlip(){
    const card = document.getElementById('card3d');
    const cvcInput = document.getElementById('cardCVV');
    if (!card || !cvcInput) return;
    cvcInput.addEventListener('focus', () => card.classList.add('flip'));
    cvcInput.addEventListener('blur',  () => card.classList.remove('flip'));
  }
  function attachTilt(){
    const stage = document.getElementById('card3dStage');
    const card  = document.getElementById('card3d');
    if (!stage || !card) return;
    stage.addEventListener('mousemove', (e) => {
      const r = stage.getBoundingClientRect();
      const px = (e.clientX - r.left) / r.width - 0.5;
      const py = (e.clientY - r.top)  / r.height - 0.5;
      const rx = (-py * 10).toFixed(2) + 'deg';
      const ry = ( px * 16).toFixed(2) + 'deg';
      card.style.setProperty('--rx', rx);
      card.style.setProperty('--ry', ry);
      card.style.setProperty('--tz', '20px');
    });
    stage.addEventListener('mouseleave', () => {
      card.style.setProperty('--rx', '0deg');
      card.style.setProperty('--ry', '0deg');
      card.style.setProperty('--tz', '0px');
    });
  }
  function setupCard3D(){
    ['cardNumber','cardHolder','cardExpiry','cardCVV']
      .map(id => document.getElementById(id))
      .filter(Boolean)
      .forEach(el => {
        el.addEventListener('input', renderCard3D);
        el.addEventListener('change', renderCard3D);
      });
    attachFlip();
    attachTilt();
    renderCard3D();
  }

  // Mostrar info de aerol√≠nea para efectivo
  function mostrarInformacionAerolineaEfectivo(aerolineaNombre) {
    const selectedAirlineName = document.getElementById('selectedAirlineName');
    const airlinePaymentName = document.getElementById('airlinePaymentName');
    if (selectedAirlineName) selectedAirlineName.textContent = aerolineaNombre || '';
    if (airlinePaymentName) airlinePaymentName.textContent = aerolineaNombre || '';
  }

  // Actualizar info del vuelo
  function actualizarInformacionVuelo(vuelo, numPasajeros, datosBusqueda) {
    console.log('üîÑ Actualizando interfaz con vuelo:', vuelo);
    if (!vuelo) {
      console.error('‚ùå No hay datos de vuelo');
      document.getElementById('flightAirline').textContent = 'Error: No se pudo cargar la informaci√≥n del vuelo';
      return;
    }
    const origenInfo = aeropuertos.find(a => a.code === vuelo.origin) || {city:'-', code:'-'};
    const destinoInfo = aeropuertos.find(a => a.code === vuelo.destination) || {city:'-', code:'-'};
    let aerolineaInfo = null;
    if (vuelo.airlineId !== 'combinado') {
      aerolineaInfo = aerolineas.find(a => a.id === vuelo.airlineId);
    }

    const airlineLogo = document.getElementById('airlineLogo');
    if (airlineLogo) {
      if (aerolineaInfo && aerolineaInfo.logo) {
        airlineLogo.src = aerolineaInfo.logo;
        airlineLogo.alt = vuelo.airline;
      } else if (vuelo.airlineId === 'combinado') {
        airlineLogo.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iI2YwZjBmMCIvPgo8dGV4dCB4PSIxNiIgeT0iMTgiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NiI+4pawK+KWsTwvdGV4dD4KPC9zdmc+';
        airlineLogo.alt = 'Vuelo combinado';
      }
    }

    document.getElementById('flightAirline').textContent = vuelo.airline;
    document.getElementById('flightCode').textContent = `C√≥digo: ${vuelo.code}`;
    document.getElementById('flightPrice').textContent = `$${Number(vuelo.price || 0).toLocaleString()}`;
    document.getElementById('departureTime').textContent = vuelo.departureTime;
    document.getElementById('arrivalTime').textContent = vuelo.arrivalTime;
    document.getElementById('originCity').textContent = `${origenInfo.city} (${origenInfo.code})`;
    document.getElementById('destinationCity').textContent = `${destinoInfo.city} (${destinoInfo.code})`;
    document.getElementById('flightDuration').textContent = vuelo.duration;
    document.getElementById('flightAircraft').textContent = `Avi√≥n: ${vuelo.aircraft}`;
    document.getElementById('flightPassengers').textContent = `Pasajeros: ${numPasajeros || 1}`;

    const fechaElement = document.getElementById('flightDate');
    if (fechaElement && datosBusqueda && datosBusqueda.fecha) {
      const fechaFormateada = new Date(datosBusqueda.fecha).toLocaleDateString('es-ES', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
      });
      fechaElement.textContent = `Fecha: ${fechaFormateada}`;
    }

    const typeBadge = document.getElementById('flightTypeBadge');
    if (typeBadge) {
      if (vuelo.escala || vuelo.flightType === 'combinado') {
        typeBadge.innerHTML = '<span class="flight-type-badge">üîÑ Vuelo con escala</span>';
        document.getElementById('flightDetails').classList.add('flight-combined');
      } else {
        typeBadge.innerHTML = '<span class="flight-type-badge">‚úàÔ∏è Vuelo directo</span>';
      }
    }

    const additionalInfo = document.getElementById('additionalInfo');
    if (additionalInfo) {
      additionalInfo.innerHTML = '';
      if (vuelo.escala && vuelo.conexion) {
        const conexionInfo = aeropuertos.find(a => a.code === vuelo.conexion);
        if (conexionInfo) {
          const escalaItem = document.createElement('div');
          escalaItem.className = 'flight-info-item';
          escalaItem.innerHTML = `<span>‚è±</span><span>Escala en ${conexionInfo.city} (${vuelo.conexion})</span>`;
          additionalInfo.appendChild(escalaItem);
        }
      }
      const seatsItem = document.createElement('div');
      seatsItem.className = 'flight-info-item';
      seatsItem.innerHTML = `<span>üí∫</span><span>${vuelo.availableSeats} asientos disponibles</span>`;
      additionalInfo.appendChild(seatsItem);
    }

    // Mostrar bloque de detalles del vuelo
    const fd = document.getElementById('flightDetails');
    if (fd) fd.style.display = 'block';

    // Info para pago en efectivo
    if (vuelo && vuelo.airline) {
      mostrarInformacionAerolineaEfectivo(vuelo.airline);
    }

    console.log('‚úÖ Interfaz actualizada correctamente');
  }

  // Info pasajero
  function actualizarInformacionPasajero(passengerData) {
    document.getElementById('passengerName').textContent = passengerData.nombre;
    document.getElementById('passengerBirthDate').textContent = passengerData.fechaNacimiento;
    document.getElementById('passengerPassport').textContent = passengerData.pasaporte;
    document.getElementById('passengerSeatPreference').textContent = passengerData.preferenciaAsiento;
  }

  // M√©todos de pago (toggle + render 3D)
  function configurarMetodosPago() {
    const paymentMethodSelect = document.getElementById('paymentMethod');
    const cardFields = document.getElementById('cardFields');
    const cashFields = document.getElementById('cashFields');

    [cardFields, cashFields].forEach(field => field.classList.remove('active'));

    paymentMethodSelect.addEventListener('change', function() {
      [cardFields, cashFields].forEach(field => field.classList.remove('active'));

      switch (this.value) {
        case 'tarjeta':
          cardFields.classList.add('active');
          // Asegura que la tarjeta 3D se pinte al activar
          setTimeout(renderCard3D, 0);
          break;
        case 'efectivo':
          cashFields.classList.add('active');
          const vueloSeleccionado = obtenerVueloSeleccionado(
            new URLSearchParams(window.location.search).get('flightId') ||
            new URLSearchParams(window.location.search).get('flight')
          );
          if (vueloSeleccionado && vueloSeleccionado.airline) {
            mostrarInformacionAerolineaEfectivo(vueloSeleccionado.airline);
          }
          break;
      }
    });
  }

  // Formateo de campos
  function configurarFormateoCampos() {
    const cardNumberInput = document.getElementById('cardNumber');
    if (cardNumberInput) {
      cardNumberInput.addEventListener('input', function(){ formatearNumeroTarjeta(this); });
    }
    const cardExpiryInput = document.getElementById('cardExpiry');
    if (cardExpiryInput) {
      cardExpiryInput.addEventListener('input', function(){ formatearFechaVencimiento(this); });
    }
  }

  // Validaciones
  function validarFormularioPago() {
    const paymentMethod = document.getElementById('paymentMethod').value;
    if (!paymentMethod) { alert('Por favor selecciona un m√©todo de pago'); return false; }
    switch (paymentMethod) {
      case 'tarjeta': return validarTarjeta();
      case 'efectivo': return true;
      default: return false;
    }
  }
  function validarTarjeta() {
    const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
    const cardExpiry = document.getElementById('cardExpiry').value;
    const cardCVV = document.getElementById('cardCVV').value;
    const cardHolder = document.getElementById('cardHolder').value;

    if (!cardNumber || cardNumber.length < 16) { alert('Por favor ingresa un n√∫mero de tarjeta v√°lido'); return false; }
    if (!cardExpiry || !/^\d{2}\/\d{2,4}$/.test(cardExpiry)) { alert('Por favor ingresa una fecha de vencimiento v√°lida (MM/AA)'); return false; }
    if (!cardCVV || cardCVV.length < 3) { alert('Por favor ingresa un CVV v√°lido'); return false; }
    if (!cardHolder) { alert('Por favor ingresa el nombre del titular de la tarjeta'); return false; }
    return true;
  }

  function procesarPago(vuelo, passengerData) {
    const paymentMethod = document.getElementById('paymentMethod').value;
    sessionStorage.setItem('metodoPago', paymentMethod);

    let mensaje = `¬°Pago procesado exitosamente!\n\nM√©todo: ${paymentMethod}\nVuelo: ${vuelo.code}\nPasajero: ${passengerData.nombre}`;
    if (paymentMethod === 'efectivo') {
      mensaje += `\n\nüíµ **Pago en efectivo:**\nDebes pagar en cualquier oficina de ${vuelo.airline}\nTienes 24 horas para realizar el pago\nPresenta tu documento y c√≥digo de reserva`;
    }
    mensaje += `\n\nSer√°s redirigido a la p√°gina de confirmaci√≥n.`;
    alert(mensaje);

    setTimeout(() => { window.location.href = 'confirmacion.html'; }, 2000);
  }

  // INICIALIZACI√ìN
  document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ PAGO.HTML - INICIANDO');

    const urlParams = new URLSearchParams(window.location.search);
    const flightId = urlParams.get('flightId') || urlParams.get('flight');
    const passengers = urlParams.get('passengers');
    console.log('üìã Par√°metros:', { flightId, passengers });

    const datosPasajerosGuardados = sessionStorage.getItem('datosPasajeros');
    let passengerData = { nombre: 'No especificado', fechaNacimiento: 'No especificado', pasaporte: 'No especificado', preferenciaAsiento: 'No especificado' };
    if (datosPasajerosGuardados) {
      try {
        const pasajeros = JSON.parse(datosPasajerosGuardados);
        if (pasajeros.length > 0) passengerData = pasajeros[0];
      } catch (error) { console.error('Error al parsear datos de pasajeros:', error); }
    }

    const busquedaGuardada = sessionStorage.getItem('busqueda');
    let datosBusqueda = null;
    if (busquedaGuardada) {
      try { datosBusqueda = JSON.parse(busquedaGuardada); }
      catch (error) { console.error('Error al parsear datos de b√∫squeda:', error); }
    }

    let vueloSeleccionado = null;
    if (flightId) vueloSeleccionado = obtenerVueloSeleccionado(flightId);
    if (!vueloSeleccionado) vueloSeleccionado = obtenerVueloSeleccionado('1');

    if (vueloSeleccionado) actualizarInformacionVuelo(vueloSeleccionado, passengers, datosBusqueda);

    actualizarInformacionPasajero(passengerData);
    configurarMetodosPago();
    configurarFormateoCampos();
    setupCard3D(); // << activa la tarjeta 3D

    document.getElementById('paymentForm').addEventListener('submit', function(e) {
      e.preventDefault();
      if (validarFormularioPago()) procesarPago(vueloSeleccionado, passengerData);
    });
  });
</script>
</body>
</html>
